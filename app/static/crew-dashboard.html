<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crew Dashboard - Flight Attendant Alerts</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="/static/css/crew-dashboard.css">
    <style>
        /* Additional styles for video feed */
        .video-feed-container {
            background: var(--color-bg-secondary, #1e1e1e);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .video-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .video-feed-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary, #ffffff);
        }
        
        .video-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary, #b0b0b0);
        }
        
        .video-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }
        
        .video-status-dot.live {
            background: #00ff00;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .video-wrapper {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-stream {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-align: center;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Active category highlight */
        .category-item.active {
            background: rgba(255,255,255,0.03);
            border-left: 3px solid var(--color-accent, #00b4d8);
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // Helper functions
        const getServiceIcon = (serviceType) => {
            const icons = {
                'beverage': 'üçπ', 'food': 'üçΩÔ∏è', 'blanket': 'üõèÔ∏è', 'pillow': 'üõèÔ∏è',
                'assistance': 'üÜò', 'medical': 'üè•', 'entertainment': 'üé¨', 'other': 'üì¢'
            };
            return icons[serviceType?.toLowerCase()] || 'üì¢';
        };

        const capitalizeFirst = (str) => {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        };

        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        };

        const playNotificationSound = (priority) => {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = priority === 'high' ? 1000 : 600;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        };

        // Video Feed Component
        function VideoFeed({ videoUrl = "/video_feed" }) {
            const [isLoading, setIsLoading] = useState(true);
            const [hasError, setHasError] = useState(false);
            const [seatData, setSeatData] = useState(null);
            const imgRef = useRef(null);

            // Fetch seat calibration data
            useEffect(() => {
                const fetchSeatData = async () => {
                    try {
                        const response = await fetch('/api/seats');
                        if (response.ok) {
                            const data = await response.json();
                            setSeatData(data);
                            console.log('Seat calibration loaded:', data);
                        }
                    } catch (error) {
                        console.error('Failed to fetch seat data:', error);
                    }
                };
                
                fetchSeatData();
                const interval = setInterval(fetchSeatData, 2000); // Refresh every 2s
                return () => clearInterval(interval);
            }, []);

            const handleLoad = () => {
                setIsLoading(false);
                setHasError(false);
            };

            const handleError = () => {
                setIsLoading(false);
                setHasError(true);
            };

            return (
                <div className="video-feed-container">
                    <div className="video-feed-header">
                        <div className="video-feed-title">üìπ Live Passenger Monitor</div>
                        <div className="video-status">
                            <div className={`video-status-dot ${!isLoading && !hasError ? 'live' : ''}`}></div>
                            <span>{!isLoading && !hasError ? 'LIVE' : hasError ? 'Disconnected' : 'Connecting...'}</span>
                        </div>
                    </div>
                    
                    {/* Seat Grid Status */}
                    {seatData && seatData.seats && Object.keys(seatData.seats).length > 0 && (
                        <div style={{
                            background: 'rgba(0,0,0,0.3)',
                            padding: '12px',
                            borderRadius: '8px',
                            marginBottom: '12px'
                        }}>
                            <div style={{
                                fontSize: '14px',
                                fontWeight: '600',
                                marginBottom: '8px',
                                color: '#00ff00'
                            }}>
                                ü™ë Seat Status ({Object.keys(seatData.seats).length} seats calibrated)
                            </div>
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                gap: '8px'
                            }}>
                                {Object.entries(seatData.seats).map(([seatId, seat]) => (
                                    <div key={seatId} style={{
                                        background: seat.occupied ? 'rgba(0,255,0,0.1)' : 'rgba(128,128,128,0.1)',
                                        border: `2px solid ${seat.occupied ? '#00ff00' : '#666'}`,
                                        borderRadius: '6px',
                                        padding: '8px',
                                        fontSize: '13px'
                                    }}>
                                        <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                            {seat.occupied ? '‚óè' : '‚óã'} {seatId}
                                        </div>
                                        {seat.occupied && seat.emotion && (
                                            <div style={{ fontSize: '11px', color: '#aaa' }}>
                                                {seat.emotion} ({Math.round(seat.confidence * 100)}%)
                                            </div>
                                        )}
                                        {!seat.occupied && (
                                            <div style={{ fontSize: '11px', color: '#666' }}>Vacant</div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className="video-wrapper">
                        {isLoading && (
                            <div className="video-overlay">
                                <div className="loading-spinner"></div>
                                <div>Connecting to camera...</div>
                            </div>
                        )}
                        {hasError && (
                            <div className="video-overlay">
                                <div style={{ fontSize: '48px', marginBottom: '10px' }}>üì∑</div>
                                <div>Camera feed unavailable</div>
                                <div style={{ fontSize: '12px', marginTop: '8px', opacity: 0.7 }}>
                                    Check camera connection
                                </div>
                            </div>
                        )}
                        <img
                            ref={imgRef}
                            src={videoUrl}
                            alt="Live camera feed"
                            className="video-stream"
                            onLoad={handleLoad}
                            onError={handleError}
                            style={{ display: hasError ? 'none' : 'block' }}
                        />
                    </div>
                </div>
            );
        }

        // Custom hook for WebSocket connection
        function useWebSocket(onMessage) {
            const [isConnected, setIsConnected] = useState(false);
            const wsRef = useRef(null);
            const reconnectTimeoutRef = useRef(null);

            const connect = useCallback(() => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/crew`;
                
                wsRef.current = new WebSocket(wsUrl);

                wsRef.current.onopen = () => {
                    console.log('WebSocket connected');
                    setIsConnected(true);
                };

                wsRef.current.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    onMessage(data);
                };

                wsRef.current.onclose = () => {
                    console.log('WebSocket disconnected');
                    setIsConnected(false);
                    reconnectTimeoutRef.current = setTimeout(connect, 3000);
                };

                wsRef.current.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }, [onMessage]);

            useEffect(() => {
                connect();
                return () => {
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                    if (reconnectTimeoutRef.current) {
                        clearTimeout(reconnectTimeoutRef.current);
                    }
                };
            }, [connect]);

            return isConnected;
        }

        // Connection Status Component
        function ConnectionStatus({ isConnected }) {
            return (
                <div className="connection-status">
                    <div className={`status-indicator ${isConnected ? 'connected' : ''}`}></div>
                    <div>
                        <div style={{ fontWeight: 600, fontSize: '14px' }}>Connection</div>
                        <div style={{ fontSize: '12px', color: 'var(--color-text-secondary)' }}>
                            {isConnected ? 'Live' : 'Reconnecting...'}
                        </div>
                    </div>
                </div>
            );
        }

        // Stats Sidebar Component
        function StatsSidebar({ alerts, isConnected, selectedCategory, onCategoryClick }) {
            const stats = useMemo(() => {
                const pending = alerts.filter(a => !a.acknowledged).length;
                const categories = { beverage: 0, food: 0, comfort: 0, medical: 0, other: 0 };

                alerts.filter(a => !a.acknowledged).forEach(alert => {
                    const type = alert.serviceType?.toLowerCase();
                    if (type === 'beverage') categories.beverage++;
                    else if (type === 'food') categories.food++;
                    else if (['blanket', 'pillow'].includes(type)) categories.comfort++;
                    else if (type === 'medical') categories.medical++;
                    else categories.other++;
                });

                return { pending, total: alerts.length, categories };
            }, [alerts]);

            return (
                <div className="sidebar">
                    <h2 style={{ marginBottom: '24px' }}>üìä Crew Panel</h2>
                    
                    <ConnectionStatus isConnected={isConnected} />

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value urgent">{stats.pending}</div>
                            <div className="stat-label">Pending</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.total}</div>
                            <div className="stat-label">Total</div>
                        </div>
                    </div>

                    <h3 style={{ marginBottom: '12px', fontSize: '14px', color: 'var(--color-text-secondary)' }}>CATEGORIES</h3>
                    <div className="category-list">
                        <div
                            className={`category-item ${selectedCategory === 'beverage' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('beverage')}
                        >
                            <span>üçπ Beverages</span>
                            <span className="category-count">{stats.categories.beverage}</span>
                        </div>
                        <div
                            className={`category-item ${selectedCategory === 'food' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('food')}
                        >
                            <span>üçΩÔ∏è Food</span>
                            <span className="category-count">{stats.categories.food}</span>
                        </div>
                        <div
                            className={`category-item ${selectedCategory === 'comfort' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('comfort')}
                        >
                            <span>üõèÔ∏è Comfort</span>
                            <span className="category-count">{stats.categories.comfort}</span>
                        </div>
                        <div
                            className={`category-item ${selectedCategory === 'medical' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('medical')}
                        >
                            <span>üè• Medical</span>
                            <span className="category-count">{stats.categories.medical}</span>
                        </div>
                        <div
                            className={`category-item ${selectedCategory === 'other' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('other')}
                        >
                            <span>üì¢ Other</span>
                            <span className="category-count">{stats.categories.other}</span>
                        </div>
                        <div
                            className={`category-item ${selectedCategory === 'video' ? 'active' : ''}`}
                            onClick={() => onCategoryClick && onCategoryClick('video')}
                            style={{ marginTop: '8px', borderTop: '1px solid rgba(255,255,255,0.04)', paddingTop: '8px' }}
                        >
                            <span>üìπ Camera Feed</span>
                            <span className="category-count">{1}</span>
                        </div>
                    </div>
                </div>
            );
        }

        // Alert Card Component
        function AlertCard({ alert, onAcknowledge }) {
            return (
                <div className={`alert-card priority-${alert.priority} ${alert.acknowledged ? 'acknowledged' : ''}`}>
                    <div className="alert-header">
                        <div>
                            <div className="alert-seat">ü™ë Seat {alert.seatNumber}</div>
                            <div className="alert-type">
                                <span>{getServiceIcon(alert.serviceType)} {capitalizeFirst(alert.serviceType)}</span>
                                {!alert.acknowledged ? (
                                    <span className={`badge badge-${alert.priority === 'high' ? 'danger' : 'warning'}`}>NEW</span>
                                ) : (
                                    <span className="badge badge-info">DONE</span>
                                )}
                            </div>
                        </div>
                        <div className="alert-time">{formatTime(alert.timestamp)}</div>
                    </div>
                    <div className="alert-message">"{alert.message}"</div>
                    {!alert.acknowledged && (
                        <div className="alert-actions">
                            <button className="btn btn-success" onClick={() => onAcknowledge(alert.id)}>
                                ‚úì Mark as Handled
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Alert List Component
        function AlertList({ alerts, filter, onAcknowledge }) {
            const filteredAlerts = useMemo(() => {
                if (filter === 'pending') {
                    return alerts.filter(a => !a.acknowledged);
                } else if (filter === 'acknowledged') {
                    return alerts.filter(a => a.acknowledged);
                }
                return alerts;
            }, [alerts, filter]);

            if (filteredAlerts.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">‚úàÔ∏è</div>
                        <h3>No Alerts</h3>
                        <p>Waiting for passenger service requests...</p>
                    </div>
                );
            }

            return (
                <div>
                    {filteredAlerts.map(alert => (
                        <AlertCard
                            key={alert.id}
                            alert={alert}
                            onAcknowledge={onAcknowledge}
                        />
                    ))}
                </div>
            );
        }

        // Filter Buttons Component
        function FilterButtons({ currentFilter, onFilterChange }) {
            const filters = [
                { key: 'all', label: 'All Alerts' },
                { key: 'pending', label: '‚è≥ Pending' },
                { key: 'acknowledged', label: '‚úì Acknowledged' }
            ];

            return (
                <div className="filter-buttons">
                    {filters.map(({ key, label }) => (
                        <button
                            key={key}
                            className={`filter-btn ${currentFilter === key ? 'active' : ''}`}
                            onClick={() => onFilterChange(key)}
                        >
                            {label}
                        </button>
                    ))}
                </div>
            );
        }

        // Main App Component
        function CrewDashboardApp() {
            const [alerts, setAlerts] = useState([]);
            const [currentFilter, setCurrentFilter] = useState('all');
            const [selectedCategory, setSelectedCategory] = useState('all');

            // Handle new alert from WebSocket
            const handleNewAlert = useCallback((alert) => {
                setAlerts(prevAlerts => {
                    // Check if alert already exists
                    const existingIndex = prevAlerts.findIndex(a => a.id === alert.id);
                    if (existingIndex !== -1) {
                        return prevAlerts;
                    }
                    
                    // Add default values if missing
                    const newAlert = {
                        ...alert,
                        id: alert.id || Date.now() + Math.random(),
                        acknowledged: alert.acknowledged ?? false
                    };
                    
                    playNotificationSound(alert.priority);
                    return [newAlert, ...prevAlerts];
                });
            }, []);

            // Connect to WebSocket
            const isConnected = useWebSocket(handleNewAlert);

            // Load existing alerts on mount
            useEffect(() => {
                const loadExistingAlerts = async () => {
                    try {
                        const response = await fetch('/api/crew/alerts');
                        if (response.ok) {
                            const existingAlerts = await response.json();
                            setAlerts(existingAlerts);
                            console.log(`Loaded ${existingAlerts.length} existing alerts`);
                        }
                    } catch (error) {
                        console.error('Failed to load existing alerts:', error);
                    }
                };
                loadExistingAlerts();
            }, []);

            // Acknowledge alert handler
            const handleAcknowledge = useCallback(async (alertId) => {
                setAlerts(prevAlerts =>
                    prevAlerts.map(alert =>
                        alert.id === alertId ? { ...alert, acknowledged: true } : alert
                    )
                );

                const alert = alerts.find(a => a.id === alertId);
                if (alert) {
                    try {
                        await fetch('/api/crew/acknowledge', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ alertId: alertId, seatNumber: alert.seatNumber })
                        });
                    } catch (error) {
                        console.error('Failed to acknowledge alert:', error);
                    }
                }
            }, [alerts]);

            return (
                <div className="dashboard-container">
                    <StatsSidebar
                        alerts={alerts}
                        isConnected={isConnected}
                        selectedCategory={selectedCategory}
                        onCategoryClick={(cat) => setSelectedCategory(cat)}
                    />

                    <div className="main-panel">
                        <div className="header">
                            <h1>üö® Crew Alert Dashboard</h1>
                        </div>

                        {/* Show video only when 'video' category selected */}
                        {selectedCategory === 'video' ? (
                            <VideoFeed />
                        ) : (
                            <div className="alert-section">
                                <FilterButtons
                                    currentFilter={currentFilter}
                                    onFilterChange={setCurrentFilter}
                                />

                                <div id="alertsList">
                                    <AlertList
                                        alerts={alerts}
                                        filter={currentFilter}
                                        onAcknowledge={handleAcknowledge}
                                    />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render app
        ReactDOM.createRoot(document.getElementById('root')).render(<CrewDashboardApp />);
    </script>
</body>
</html>