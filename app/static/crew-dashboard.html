<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crew Dashboard - Flight Attendant Alerts</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="/static/css/crew-dashboard.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // Helper functions
        const getServiceIcon = (serviceType) => {
            const icons = {
                'beverage': 'üçπ', 'food': 'üçΩÔ∏è', 'blanket': 'üõèÔ∏è', 'pillow': 'üõèÔ∏è',
                'assistance': 'üÜò', 'medical': 'üè•', 'entertainment': 'üé¨', 'other': 'üì¢'
            };
            return icons[serviceType?.toLowerCase()] || 'üì¢';
        };

        const capitalizeFirst = (str) => {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        };

        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        };

        const playNotificationSound = (priority) => {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = priority === 'high' ? 1000 : 600;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        };

        // Custom hook for WebSocket connection
        function useWebSocket(onMessage) {
            const [isConnected, setIsConnected] = useState(false);
            const wsRef = useRef(null);
            const reconnectTimeoutRef = useRef(null);

            const connect = useCallback(() => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/crew`;
                
                wsRef.current = new WebSocket(wsUrl);

                wsRef.current.onopen = () => {
                    console.log('WebSocket connected');
                    setIsConnected(true);
                };

                wsRef.current.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    onMessage(data);
                };

                wsRef.current.onclose = () => {
                    console.log('WebSocket disconnected');
                    setIsConnected(false);
                    reconnectTimeoutRef.current = setTimeout(connect, 3000);
                };

                wsRef.current.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }, [onMessage]);

            useEffect(() => {
                connect();
                return () => {
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                    if (reconnectTimeoutRef.current) {
                        clearTimeout(reconnectTimeoutRef.current);
                    }
                };
            }, [connect]);

            return isConnected;
        }

        // Connection Status Component
        function ConnectionStatus({ isConnected }) {
            return (
                <div className="connection-status">
                    <div className={`status-indicator ${isConnected ? 'connected' : ''}`}></div>
                    <div>
                        <div style={{ fontWeight: 600, fontSize: '14px' }}>Connection</div>
                        <div style={{ fontSize: '12px', color: 'var(--color-text-secondary)' }}>
                            {isConnected ? 'Live' : 'Reconnecting...'}
                        </div>
                    </div>
                </div>
            );
        }

        // Stats Sidebar Component
        function StatsSidebar({ alerts, isConnected }) {
            const stats = useMemo(() => {
                const pending = alerts.filter(a => !a.acknowledged).length;
                const categories = { beverage: 0, food: 0, comfort: 0, medical: 0, other: 0 };

                alerts.filter(a => !a.acknowledged).forEach(alert => {
                    const type = alert.serviceType?.toLowerCase();
                    if (type === 'beverage') categories.beverage++;
                    else if (type === 'food') categories.food++;
                    else if (['blanket', 'pillow'].includes(type)) categories.comfort++;
                    else if (type === 'medical') categories.medical++;
                    else categories.other++;
                });

                return { pending, total: alerts.length, categories };
            }, [alerts]);

            return (
                <div className="sidebar">
                    <h2 style={{ marginBottom: '24px' }}>üìä Crew Panel</h2>
                    
                    <ConnectionStatus isConnected={isConnected} />

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value urgent">{stats.pending}</div>
                            <div className="stat-label">Pending</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.total}</div>
                            <div className="stat-label">Total</div>
                        </div>
                    </div>

                    <h3 style={{ marginBottom: '12px', fontSize: '14px', color: 'var(--color-text-secondary)' }}>CATEGORIES</h3>
                    <div className="category-list">
                        <div className="category-item">
                            <span>üçπ Beverages</span>
                            <span className="category-count">{stats.categories.beverage}</span>
                        </div>
                        <div className="category-item">
                            <span>üçΩÔ∏è Food</span>
                            <span className="category-count">{stats.categories.food}</span>
                        </div>
                        <div className="category-item">
                            <span>üõèÔ∏è Comfort</span>
                            <span className="category-count">{stats.categories.comfort}</span>
                        </div>
                        <div className="category-item">
                            <span>üè• Medical</span>
                            <span className="category-count">{stats.categories.medical}</span>
                        </div>
                        <div className="category-item">
                            <span>üì¢ Other</span>
                            <span className="category-count">{stats.categories.other}</span>
                        </div>
                    </div>
                </div>
            );
        }

        // Alert Card Component
        function AlertCard({ alert, onAcknowledge }) {
            return (
                <div className={`alert-card priority-${alert.priority} ${alert.acknowledged ? 'acknowledged' : ''}`}>
                    <div className="alert-header">
                        <div>
                            <div className="alert-seat">ü™ë Seat {alert.seatNumber}</div>
                            <div className="alert-type">
                                <span>{getServiceIcon(alert.serviceType)} {capitalizeFirst(alert.serviceType)}</span>
                                {!alert.acknowledged ? (
                                    <span className={`badge badge-${alert.priority === 'high' ? 'danger' : 'warning'}`}>NEW</span>
                                ) : (
                                    <span className="badge badge-info">DONE</span>
                                )}
                            </div>
                        </div>
                        <div className="alert-time">{formatTime(alert.timestamp)}</div>
                    </div>
                    <div className="alert-message">"{alert.message}"</div>
                    {!alert.acknowledged && (
                        <div className="alert-actions">
                            <button className="btn btn-success" onClick={() => onAcknowledge(alert.id)}>
                                ‚úì Mark as Handled
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Alert List Component
        function AlertList({ alerts, filter, onAcknowledge }) {
            const filteredAlerts = useMemo(() => {
                if (filter === 'pending') {
                    return alerts.filter(a => !a.acknowledged);
                } else if (filter === 'acknowledged') {
                    return alerts.filter(a => a.acknowledged);
                }
                return alerts;
            }, [alerts, filter]);

            if (filteredAlerts.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">‚úàÔ∏è</div>
                        <h3>No Alerts</h3>
                        <p>Waiting for passenger service requests...</p>
                    </div>
                );
            }

            return (
                <div>
                    {filteredAlerts.map(alert => (
                        <AlertCard
                            key={alert.id}
                            alert={alert}
                            onAcknowledge={onAcknowledge}
                        />
                    ))}
                </div>
            );
        }

        // Filter Buttons Component
        function FilterButtons({ currentFilter, onFilterChange }) {
            const filters = [
                { key: 'all', label: 'All Alerts' },
                { key: 'pending', label: '‚è≥ Pending' },
                { key: 'acknowledged', label: '‚úì Acknowledged' }
            ];

            return (
                <div className="filter-buttons">
                    {filters.map(({ key, label }) => (
                        <button
                            key={key}
                            className={`filter-btn ${currentFilter === key ? 'active' : ''}`}
                            onClick={() => onFilterChange(key)}
                        >
                            {label}
                        </button>
                    ))}
                </div>
            );
        }

        // Main App Component
        function CrewDashboardApp() {
            const [alerts, setAlerts] = useState([]);
            const [currentFilter, setCurrentFilter] = useState('all');

            // Handle new alert from WebSocket
            const handleNewAlert = useCallback((alert) => {
                setAlerts(prevAlerts => {
                    // Check if alert already exists
                    const existingIndex = prevAlerts.findIndex(a => a.id === alert.id);
                    if (existingIndex !== -1) {
                        return prevAlerts;
                    }
                    
                    // Add default values if missing
                    const newAlert = {
                        ...alert,
                        id: alert.id || Date.now() + Math.random(),
                        acknowledged: alert.acknowledged ?? false
                    };
                    
                    playNotificationSound(alert.priority);
                    return [newAlert, ...prevAlerts];
                });
            }, []);

            // Connect to WebSocket
            const isConnected = useWebSocket(handleNewAlert);

            // Load existing alerts on mount
            useEffect(() => {
                const loadExistingAlerts = async () => {
                    try {
                        const response = await fetch('/api/crew/alerts');
                        if (response.ok) {
                            const existingAlerts = await response.json();
                            setAlerts(existingAlerts);
                            console.log(`Loaded ${existingAlerts.length} existing alerts`);
                        }
                    } catch (error) {
                        console.error('Failed to load existing alerts:', error);
                    }
                };
                loadExistingAlerts();
            }, []);

            // Acknowledge alert handler
            const handleAcknowledge = useCallback(async (alertId) => {
                setAlerts(prevAlerts =>
                    prevAlerts.map(alert =>
                        alert.id === alertId ? { ...alert, acknowledged: true } : alert
                    )
                );

                const alert = alerts.find(a => a.id === alertId);
                if (alert) {
                    try {
                        await fetch('/api/crew/acknowledge', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ alertId: alertId, seatNumber: alert.seatNumber })
                        });
                    } catch (error) {
                        console.error('Failed to acknowledge alert:', error);
                    }
                }
            }, [alerts]);

            return (
                <div className="dashboard-container">
                    <StatsSidebar alerts={alerts} isConnected={isConnected} />

                    <div className="main-panel">
                        <div className="header">
                            <h1>üö® Crew Alert Dashboard</h1>
                        </div>

                        <div className="alert-section">
                            <FilterButtons
                                currentFilter={currentFilter}
                                onFilterChange={setCurrentFilter}
                            />

                            <div id="alertsList">
                                <AlertList
                                    alerts={alerts}
                                    filter={currentFilter}
                                    onAcknowledge={handleAcknowledge}
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Render app
        ReactDOM.createRoot(document.getElementById('root')).render(<CrewDashboardApp />);
    </script>
</body>
</html>
